<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‰í‰í‰í‰! ì†Œë¦¬ì˜ ê³¼í•™ ê²Œì„ ì‹¤í—˜ì‹¤</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes wave {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0; }
        }
        .wave-ring {
            animation: wave 2s ease-out infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .pulse-ring {
            animation: pulse-ring 1s ease-out forwards;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.3s ease-in-out;
        }
        .bg-gradient-sky {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .bg-gradient-space {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        .bg-gradient-ocean {
            background: linear-gradient(135deg, #2e3192 0%, #1bffff 100%);
        }
        .bg-gradient-forest {
            background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Supabase ì´ˆê¸°í™”
        const SUPABASE_URL = 'https://fuluhwxjgovrvvpaaoyn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1bHVod3hqZ292cnZ2cGFhb3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNTUzNDcsImV4cCI6MjA3NjczMTM0N30.mvu9kqYvZ4txYBctcWivPjRf_lGTZwPdKEaZMbNnrxY';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ë°ì´í„°ë² ì´ìŠ¤ í—¬í¼ í•¨ìˆ˜ë“¤
        const DB = {
            // ì„¸ì…˜ ID ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ìƒì„±
            getSessionId() {
                let sessionId = localStorage.getItem('octsky_session_id');
                if (!sessionId) {
                    sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('octsky_session_id', sessionId);
                }
                return sessionId;
            },

            // íŒ€ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
            async getTeams(sessionId) {
                try {
                    const { data, error } = await supabase
                        .from('team_scores')
                        .select('*')
                        .eq('session_id', sessionId)
                        .order('team_index', { ascending: true });

                    if (error) throw error;
                    return data || [];
                } catch (err) {
                    console.error('Error getting teams:', err);
                    return [];
                }
            },

            // íŒ€ ì ìˆ˜ ì—…ë°ì´íŠ¸
            async updateTeam(sessionId, teamIndex, teamData) {
                try {
                    const { data, error } = await supabase
                        .from('team_scores')
                        .upsert({
                            session_id: sessionId,
                            team_index: teamIndex,
                            team_name: teamData.name,
                            score: teamData.score,
                            combo: teamData.combo,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'session_id,team_index'
                        });

                    if (error) throw error;
                    return true;
                } catch (err) {
                    console.error('Error updating team:', err);
                    return false;
                }
            },

            // íŒ€ ì ìˆ˜ ì´ˆê¸°í™”
            async resetTeams(sessionId) {
                try {
                    const { error } = await supabase
                        .from('team_scores')
                        .delete()
                        .eq('session_id', sessionId);

                    if (error) throw error;
                    return true;
                } catch (err) {
                    console.error('Error resetting teams:', err);
                    return false;
                }
            },

            // ì‹¤ì‹œê°„ êµ¬ë…
            subscribeToTeams(sessionId, callback) {
                const channel = supabase
                    .channel('team_scores_changes')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'team_scores',
                            filter: `session_id=eq.${sessionId}`
                        },
                        (payload) => {
                            callback(payload);
                        }
                    )
                    .subscribe();

                return channel;
            }
        };

        // ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
            }

            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }

            // ì£¼íŒŒìˆ˜ë¡œ ì†Œë¦¬ ìƒì„±
            playTone(frequency, duration = 0.15, type = 'sine', volume = 0.3) {
                this.init();
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = type;

                gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            // ì‚¬ìš´ë“œíŒ©ë³„ ì†Œë¦¬
            playSound(soundPack, type = 'beat') {
                this.init();

                const soundMap = {
                    drum: {
                        beat: () => this.playTone(100, 0.1, 'triangle', 0.1),
                        perfect: () => this.playTone(800, 0.15, 'sine', 0.25),
                        great: () => this.playTone(600, 0.15, 'sine', 0.25),
                        good: () => this.playTone(400, 0.15, 'sine', 0.25),
                        miss: () => this.playTone(150, 0.1, 'sawtooth', 0.2)
                    },
                    piano: {
                        beat: () => this.playTone(440, 0.2, 'sine', 0.1),
                        perfect: () => this.playTone(880, 0.2, 'sine', 0.25),
                        great: () => this.playTone(660, 0.2, 'sine', 0.25),
                        good: () => this.playTone(550, 0.2, 'sine', 0.25),
                        miss: () => this.playTone(220, 0.15, 'square', 0.2)
                    },
                    space: {
                        beat: () => this.playTone(200, 0.1, 'square', 0.1),
                        perfect: () => {
                            this.playTone(1000, 0.1, 'square', 0.25);
                            setTimeout(() => this.playTone(1200, 0.1, 'square', 0.25), 50);
                        },
                        great: () => this.playTone(800, 0.15, 'square', 0.25),
                        good: () => this.playTone(600, 0.15, 'square', 0.25),
                        miss: () => this.playTone(100, 0.2, 'sawtooth', 0.2)
                    },
                    animal: {
                        beat: () => this.playTone(300, 0.1, 'triangle', 0.1),
                        perfect: () => {
                            this.playTone(600, 0.05, 'sine', 0.25);
                            setTimeout(() => this.playTone(800, 0.05, 'sine', 0.25), 50);
                        },
                        great: () => this.playTone(500, 0.1, 'sine', 0.25),
                        good: () => this.playTone(400, 0.1, 'sine', 0.25),
                        miss: () => this.playTone(200, 0.15, 'triangle', 0.2)
                    }
                };

                const packSounds = soundMap[soundPack] || soundMap.drum;
                const soundFunc = packSounds[type] || packSounds.beat;
                soundFunc();
            }

            // ë©”íŠ¸ë¡œë†ˆ ì†Œë¦¬
            playMetronome() {
                this.playTone(1000, 0.05, 'square', 0.15);
            }
        }

        // ì „ì—­ ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ ì¸ìŠ¤í„´ìŠ¤
        const soundSystem = new SoundSystem();

        // ë©”ì¸ ì•± ì»´í¬ë„ŒíŠ¸
        function App() {
            const [currentScreen, setCurrentScreen] = useState('home');
            const [gameSettings, setGameSettings] = useState({
                bpm: 80,
                difficulty: 'easy',
                soundPack: 'drum',
                theme: 'sky',
                vibration: true,
                guideLine: true
            });
            const [sessionId, setSessionId] = useState(DB.getSessionId());
            const [currentTeam, setCurrentTeam] = useState(0);

            const handleScoreSubmit = async (scoreData) => {
                // í˜„ì¬ íŒ€ì— ì ìˆ˜ ê¸°ë¡
                await DB.updateTeam(sessionId, currentTeam, {
                    name: `${currentTeam + 1}íŒ€`,
                    score: scoreData.score,
                    combo: scoreData.maxCombo
                });
                // ë‹¤ìŒ íŒ€ìœ¼ë¡œ ì´ë™
                setCurrentTeam((prev) => (prev + 1) % 3);
            };

            const screens = {
                home: <HomeScreen onNavigate={setCurrentScreen} sessionId={sessionId} />,
                learn: <LearnScreen onNavigate={setCurrentScreen} />,
                settings: <SettingsScreen
                    settings={gameSettings}
                    onSettingsChange={setGameSettings}
                    onNavigate={setCurrentScreen}
                />,
                game: <GameScreen
                    settings={gameSettings}
                    onNavigate={setCurrentScreen}
                    onScoreSubmit={handleScoreSubmit}
                    currentTeam={currentTeam}
                />,
                miniGame: <MiniGameScreen onNavigate={setCurrentScreen} />,
                teamBattle: <TeamBattleScreen
                    sessionId={sessionId}
                    onNavigate={setCurrentScreen}
                    currentTeam={currentTeam}
                    setCurrentTeam={setCurrentTeam}
                />
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {screens[currentScreen]}
                </div>
            );
        }

        // í™ˆ í™”ë©´
        function HomeScreen({ onNavigate, sessionId }) {
            return (
                <div className="min-h-screen bg-gradient-sky flex flex-col items-center justify-center p-6">
                    <div className="text-center mb-12">
                        <h1 className="text-5xl font-bold text-white mb-4">
                            í‰í‰í‰í‰!
                        </h1>
                        <h2 className="text-3xl font-semibold text-white mb-2">
                            ì†Œë¦¬ì˜ ê³¼í•™ ê²Œì„ ì‹¤í—˜ì‹¤
                        </h2>
                        <p className="text-xl text-white/90">
                            ì˜¤ëŠ˜ì˜ ê³¼í•™ìê°€ ë‚´ì¼ì˜ ê³¼í•™ìë¥¼ ë§Œë‚œë‹¤!
                        </p>
                        <div className="mt-4 bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2 inline-block">
                            <p className="text-sm text-white/80">ì„¸ì…˜ ì½”ë“œ</p>
                            <p className="text-lg font-mono font-bold text-white">{sessionId.split('_')[1]}</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full space-y-4">
                        <MenuButton 
                            icon="ğŸ“" 
                            title="ì†Œë¦¬ì˜ ê³¼í•™ ë°°ìš°ê¸°"
                            description="ì§„ë™, íŒŒë™, ì£¼íŒŒìˆ˜ë¥¼ ì•Œì•„ë³´ì•„ìš”"
                            onClick={() => onNavigate('learn')}
                            color="bg-blue-500"
                        />
                        
                        <MenuButton 
                            icon="âš™ï¸" 
                            title="ê²Œì„ ì„¤ì •í•˜ê¸°"
                            description="ë‚œì´ë„ì™€ ì‚¬ìš´ë“œë¥¼ ì„ íƒí•´ìš”"
                            onClick={() => onNavigate('settings')}
                            color="bg-purple-500"
                        />
                        
                        <MenuButton 
                            icon="ğŸ®" 
                            title="ë¦¬ë“¬ ê²Œì„ ì‹œì‘"
                            description="ë¹›ì˜ ê³ ë¦¬ë¥¼ ì •í™•íˆ íƒ­í•˜ì„¸ìš”"
                            onClick={() => onNavigate('game')}
                            color="bg-green-500"
                        />
                        
                        <MenuButton 
                            icon="ğŸ¯" 
                            title="ì†Œë¦¬ ë§íˆê¸° ê²Œì„"
                            description="ë¯¸ë‹ˆ ê²Œì„ìœ¼ë¡œ ì†Œë¦¬ë¥¼ ë°°ì›Œìš”"
                            onClick={() => onNavigate('miniGame')}
                            color="bg-orange-500"
                        />
                        
                        <MenuButton 
                            icon="ğŸ†" 
                            title="ê°€ì¡± ëŒ€í•­ì „"
                            description="íŒ€ë³„ë¡œ ê²½ìŸí•´ë³´ì„¸ìš”"
                            onClick={() => onNavigate('teamBattle')}
                            color="bg-red-500"
                        />
                    </div>

                    <p className="text-white/80 mt-8 text-center">
                        ì´ˆë“± 3í•™ë…„ ëˆˆë†’ì´ë¡œ í•¨ê»˜ ë†€ì´í•˜ë©° ë°°ì›Œìš” ğŸŒŸ
                    </p>
                </div>
            );
        }

        // ë©”ë‰´ ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸
        function MenuButton({ icon, title, description, onClick, color }) {
            return (
                <button
                    onClick={onClick}
                    className={`w-full ${color} hover:opacity-90 transition-all duration-200 rounded-xl p-4 text-left shadow-lg hover:shadow-xl transform hover:scale-105`}
                >
                    <div className="flex items-center space-x-4">
                        <span className="text-4xl">{icon}</span>
                        <div className="flex-1">
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                            <p className="text-sm text-white/80">{description}</p>
                        </div>
                    </div>
                </button>
            );
        }

        // í•™ìŠµ í™”ë©´
        function LearnScreen({ onNavigate }) {
            const [currentSection, setCurrentSection] = useState(0);

            const sections = [
                {
                    title: "ì†Œë¦¬ë€ ë¬´ì—‡ì¼ê¹Œ?",
                    icon: "ğŸ”Š",
                    content: (
                        <div className="space-y-4">
                            <div className="bg-blue-50 p-4 rounded-lg">
                                <h4 className="font-bold text-blue-800 mb-2">ğŸ’« ì†Œë¦¬ëŠ” 'ë–¨ë¦¼(ì§„ë™)'ì—ì„œ ì‹œì‘!</h4>
                                <p className="text-gray-700">
                                    ë¬¼ì²´ê°€ ë–¨ë¦¬ë©´ì„œ ê³µê¸°ë¥¼ ì§„ë™ì‹œí‚¤ê³ , ê·¸ ì§„ë™ì´ ìš°ë¦¬ ê·€ì— ì „ë‹¬ë˜ì–´ ì†Œë¦¬ë¥¼ ë“¤ì„ ìˆ˜ ìˆì–´ìš”.
                                </p>
                            </div>
                            <div className="bg-purple-50 p-4 rounded-lg">
                                <h4 className="font-bold text-purple-800 mb-2">ğŸŒŠ ê³µê¸°ë¥¼ íƒ€ê³  'íŒŒë™'ìœ¼ë¡œ í¼ì ¸ìš”</h4>
                                <p className="text-gray-700">
                                    ì—°ëª»ì— ëŒì„ ë˜ì¡Œì„ ë•Œ ë¬¼ê²°ì´ í¼ì§€ëŠ” ê²ƒì²˜ëŸ¼, ì†Œë¦¬ë„ ê³µê¸° ì†ì—ì„œ íŒŒë™ì˜ í˜•íƒœë¡œ í¼ì ¸ë‚˜ê°€ìš”.
                                </p>
                            </div>
                            <div className="bg-yellow-50 p-4 rounded-lg">
                                <p className="text-gray-700 italic">
                                    ğŸ’¡ ì†Œë¦¬ê°€ ì—†ëŠ” ìš°ì£¼ì—ì„œëŠ” ì„œë¡œ ë§ì†Œë¦¬ë¥¼ ë“¤ì„ ìˆ˜ ì—†ì–´ìš”! ì™œì¼ê¹Œìš”?
                                </p>
                            </div>
                        </div>
                    )
                },
                {
                    title: "ì§„ë™ì„ ëŠê»´ë³´ì„¸ìš”",
                    icon: "ğŸ‘‹",
                    content: (
                        <div className="space-y-4">
                            <div className="bg-green-50 p-4 rounded-lg">
                                <h4 className="font-bold text-green-800 mb-2">ğŸ¤ ëª©ì— ì† ëŒ€ê³  'ì•„â€”' ì†Œë¦¬ ë‚´ê¸°</h4>
                                <p className="text-gray-700">
                                    ëª©ì— ì†ì„ ê°€ë³ê²Œ ëŒ€ê³  'ì•„â€”' ì†Œë¦¬ë¥¼ ë‚´ë³¼ê¹Œìš”? ì†ìœ¼ë¡œ ëª©ì—ì„œ ëŠê»´ì§€ëŠ” ì§„ë™ì„ ëŠê»´ë³´ì„¸ìš”.
                                </p>
                            </div>
                            <div className="bg-orange-50 p-4 rounded-lg">
                                <h4 className="font-bold text-orange-800 mb-2">ğŸ“± íƒìì— íœ´ëŒ€í° ìŒì•… ì˜¬ë ¤ë‘ê¸°</h4>
                                <p className="text-gray-700">
                                    íœ´ëŒ€í°ì—ì„œ ìŒì•…ì„ ì¬ìƒí•œ ë’¤ íƒì ìœ„ì— ì˜¬ë ¤ë†“ìœ¼ì„¸ìš”. íœ´ëŒ€í°ê³¼ íƒìê°€ í•¨ê»˜ ì§„ë™í•˜ëŠ” ëª¨ìŠµì„ ê´€ì°°í•  ìˆ˜ ìˆì–´ìš”!
                                </p>
                            </div>
                        </div>
                    )
                },
                {
                    title: "ì£¼íŒŒìˆ˜ì™€ ìŒì˜ ë†’ë‚®ì´",
                    icon: "ğŸµ",
                    content: (
                        <div className="space-y-4">
                            <div className="bg-pink-50 p-4 rounded-lg">
                                <h4 className="font-bold text-pink-800 mb-2">âš¡ 1ì´ˆì— ëª‡ ë²ˆ ë–¨ë¦¬ë‚˜?</h4>
                                <p className="text-gray-700 mb-3">
                                    ì£¼íŒŒìˆ˜(Hz) = 1ì´ˆ ë™ì•ˆ ì§„ë™ íšŸìˆ˜
                                </p>
                                <div className="space-y-2">
                                    <div className="flex items-center space-x-2">
                                        <span className="text-2xl">ğŸ‘§</span>
                                        <span className="text-gray-700">ì–´ë¦°ì´ ëª©ì†Œë¦¬: ë†’ì€ ì£¼íŒŒìˆ˜ (200-300Hz)</span>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <span className="text-2xl">ğŸ¹</span>
                                        <span className="text-gray-700">í”¼ì•„ë…¸: ì¤‘ê°„ ì£¼íŒŒìˆ˜</span>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <span className="text-2xl">ğŸ‘¨</span>
                                        <span className="text-gray-700">ì•„ë¹  ëª©ì†Œë¦¬: ë‚®ì€ ì£¼íŒŒìˆ˜ (85-180Hz)</span>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-indigo-50 p-4 rounded-lg">
                                <p className="text-gray-700 font-semibold">
                                    ğŸ’¡ ë¹ ë¥´ê²Œ ë–¨ë¦¬ë©´ ë†’ì€ ìŒ, ëŠë¦¬ê²Œ ë–¨ë¦¬ë©´ ë‚®ì€ ìŒ!
                                </p>
                            </div>
                        </div>
                    )
                },
                {
                    title: "ë¦¬ë“¬ì´ë€?",
                    icon: "ğŸ¼",
                    content: (
                        <div className="space-y-4">
                            <div className="bg-teal-50 p-4 rounded-lg">
                                <h4 className="font-bold text-teal-800 mb-2">ğŸ“ ì¼ì •í•œ ê°„ê²©ì˜ ê·œì¹™ê³¼ íŒ¨í„´</h4>
                                <p className="text-gray-700">
                                    ë¦¬ë“¬ì€ ìŒì•…ì˜ ì‹¬ì¥ì´ì—ìš”. BPM(ë¶„ë‹¹ ë°•ìˆ˜/ë¹„íŠ¸ ìˆ˜)ìœ¼ë¡œ ì†ë„ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
                                </p>
                            </div>
                            <div className="bg-cyan-50 p-4 rounded-lg">
                                <h4 className="font-bold text-cyan-800 mb-2">ğŸ‘ ë‹¤ ê°™ì´ 'í‰Â·í‰Â·í‰Â·í‰' ì†ë¼‰!</h4>
                                <p className="text-gray-700">
                                    ì¼ì •í•œ ê°„ê²©ìœ¼ë¡œ ì†ë¼‰ì„ ì¹˜ë©´ ë¦¬ë“¬ì´ ë§Œë“¤ì–´ì ¸ìš”. ë¹ ë¥´ê¸°ë¥¼ ë°”ê¾¸ë©´ ëŠë‚Œë„ ë‹¬ë¼ì ¸ìš”!
                                </p>
                            </div>
                        </div>
                    )
                }
            ];

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 p-6">
                    <div className="max-w-2xl mx-auto">
                        {/* í—¤ë” */}
                        <div className="flex items-center justify-between mb-6">
                            <button
                                onClick={() => onNavigate('home')}
                                className="px-4 py-2 bg-white rounded-lg shadow hover:shadow-md transition-shadow"
                            >
                                â† í™ˆìœ¼ë¡œ
                            </button>
                            <h2 className="text-2xl font-bold text-gray-800">ì†Œë¦¬ì˜ ê³¼í•™ ë°°ìš°ê¸°</h2>
                            <div className="w-20"></div>
                        </div>

                        {/* ì§„í–‰ ë°” */}
                        <div className="mb-6">
                            <div className="flex justify-between mb-2">
                                {sections.map((_, index) => (
                                    <div
                                        key={index}
                                        className={`h-2 flex-1 mx-1 rounded-full transition-colors ${
                                            index <= currentSection ? 'bg-blue-500' : 'bg-gray-300'
                                        }`}
                                    />
                                ))}
                            </div>
                            <p className="text-center text-sm text-gray-600">
                                {currentSection + 1} / {sections.length}
                            </p>
                        </div>

                        {/* ì½˜í…ì¸  */}
                        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
                            <div className="text-center mb-6">
                                <span className="text-6xl mb-4 inline-block">{sections[currentSection].icon}</span>
                                <h3 className="text-3xl font-bold text-gray-800">
                                    {sections[currentSection].title}
                                </h3>
                            </div>
                            {sections[currentSection].content}
                        </div>

                        {/* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */}
                        <div className="flex justify-between">
                            <button
                                onClick={() => setCurrentSection(Math.max(0, currentSection - 1))}
                                disabled={currentSection === 0}
                                className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                                    currentSection === 0
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        : 'bg-blue-500 text-white hover:bg-blue-600'
                                }`}
                            >
                                â† ì´ì „
                            </button>
                            
                            {currentSection < sections.length - 1 ? (
                                <button
                                    onClick={() => setCurrentSection(currentSection + 1)}
                                    className="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-all"
                                >
                                    ë‹¤ìŒ â†’
                                </button>
                            ) : (
                                <button
                                    onClick={() => onNavigate('settings')}
                                    className="px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition-all"
                                >
                                    ê²Œì„ ì‹œì‘í•˜ê¸° ğŸ®
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ì„¤ì • í™”ë©´
        function SettingsScreen({ settings, onSettingsChange, onNavigate }) {
            const presets = {
                beginner: { bpm: 80, difficulty: 'easy', guideLine: true },
                intermediate: { bpm: 110, difficulty: 'normal', guideLine: true },
                advanced: { bpm: 140, difficulty: 'hard', guideLine: false }
            };

            const applyPreset = (preset) => {
                onSettingsChange({ ...settings, ...presets[preset] });
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-6">
                    <div className="max-w-2xl mx-auto">
                        {/* í—¤ë” */}
                        <div className="flex items-center justify-between mb-6">
                            <button
                                onClick={() => onNavigate('home')}
                                className="px-4 py-2 bg-white rounded-lg shadow hover:shadow-md transition-shadow"
                            >
                                â† í™ˆìœ¼ë¡œ
                            </button>
                            <h2 className="text-2xl font-bold text-gray-800">ê²Œì„ ì„¤ì •</h2>
                            <div className="w-20"></div>
                        </div>

                        <div className="bg-white rounded-2xl shadow-xl p-8 space-y-6">
                            {/* ë‚œì´ë„ í”„ë¦¬ì…‹ */}
                            <div>
                                <h3 className="text-xl font-bold text-gray-800 mb-4">â­ ë‚œì´ë„ í”„ë¦¬ì…‹</h3>
                                <div className="grid grid-cols-3 gap-4">
                                    <button
                                        onClick={() => applyPreset('beginner')}
                                        className="p-4 bg-green-100 hover:bg-green-200 rounded-lg transition-colors"
                                    >
                                        <div className="text-3xl mb-2">ğŸŸ¢</div>
                                        <div className="font-bold text-green-800">ì´ˆê¸‰</div>
                                        <div className="text-sm text-gray-600">BPM 80</div>
                                    </button>
                                    <button
                                        onClick={() => applyPreset('intermediate')}
                                        className="p-4 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-colors"
                                    >
                                        <div className="text-3xl mb-2">ğŸŸ¡</div>
                                        <div className="font-bold text-yellow-800">ì¤‘ê¸‰</div>
                                        <div className="text-sm text-gray-600">BPM 110</div>
                                    </button>
                                    <button
                                        onClick={() => applyPreset('advanced')}
                                        className="p-4 bg-red-100 hover:bg-red-200 rounded-lg transition-colors"
                                    >
                                        <div className="text-3xl mb-2">ğŸ”´</div>
                                        <div className="font-bold text-red-800">ê³ ê¸‰</div>
                                        <div className="text-sm text-gray-600">BPM 140</div>
                                    </button>
                                </div>
                            </div>

                            {/* BPM ì„¤ì • */}
                            <div>
                                <label className="block text-lg font-bold text-gray-800 mb-2">
                                    ğŸµ ì†ë„ (BPM): {settings.bpm}
                                </label>
                                <input
                                    type="range"
                                    min="60"
                                    max="180"
                                    step="10"
                                    value={settings.bpm}
                                    onChange={(e) => onSettingsChange({ ...settings, bpm: parseInt(e.target.value) })}
                                    className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                />
                                <div className="flex justify-between text-sm text-gray-600 mt-1">
                                    <span>ëŠë¦¼ (60)</span>
                                    <span>ë³´í†µ (120)</span>
                                    <span>ë¹ ë¦„ (180)</span>
                                </div>
                            </div>

                            {/* íŒì • ë‚œì´ë„ */}
                            <div>
                                <label className="block text-lg font-bold text-gray-800 mb-2">
                                    ğŸ¯ íŒì • ë‚œì´ë„
                                </label>
                                <div className="grid grid-cols-3 gap-4">
                                    {['easy', 'normal', 'hard'].map((diff) => (
                                        <button
                                            key={diff}
                                            onClick={() => onSettingsChange({ ...settings, difficulty: diff })}
                                            className={`p-3 rounded-lg font-semibold transition-all ${
                                                settings.difficulty === diff
                                                    ? 'bg-blue-500 text-white shadow-lg scale-105'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                        >
                                            {diff === 'easy' ? 'ì‰¬ì›€' : diff === 'normal' ? 'ë³´í†µ' : 'ì–´ë ¤ì›€'}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* ì‚¬ìš´ë“œíŒ© */}
                            <div>
                                <label className="block text-lg font-bold text-gray-800 mb-2">
                                    ğŸ¼ ì‚¬ìš´ë“œíŒ©
                                </label>
                                <div className="grid grid-cols-2 gap-4">
                                    {[
                                        { value: 'drum', icon: 'ğŸ¥', label: 'ë“œëŸ¼' },
                                        { value: 'piano', icon: 'ğŸ¹', label: 'í”¼ì•„ë…¸' },
                                        { value: 'space', icon: 'ğŸš€', label: 'ìš°ì£¼ì„ ' },
                                        { value: 'animal', icon: 'ğŸ¾', label: 'ë™ë¬¼' }
                                    ].map(({ value, icon, label }) => (
                                        <button
                                            key={value}
                                            onClick={() => {
                                                onSettingsChange({ ...settings, soundPack: value });
                                                soundSystem.playSound(value, 'perfect');
                                            }}
                                            className={`p-4 rounded-lg font-semibold transition-all ${
                                                settings.soundPack === value
                                                    ? 'bg-purple-500 text-white shadow-lg scale-105'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                        >
                                            <div className="text-3xl mb-1">{icon}</div>
                                            {label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* í…Œë§ˆ */}
                            <div>
                                <label className="block text-lg font-bold text-gray-800 mb-2">
                                    ğŸ¨ í…Œë§ˆ
                                </label>
                                <div className="grid grid-cols-2 gap-4">
                                    {[
                                        { value: 'sky', icon: 'â˜ï¸', label: 'í•˜ëŠ˜' },
                                        { value: 'space', icon: 'ğŸŒŒ', label: 'ìš°ì£¼' },
                                        { value: 'ocean', icon: 'ğŸŒŠ', label: 'ë°”ë‹¤' },
                                        { value: 'forest', icon: 'ğŸŒ²', label: 'ìˆ²' }
                                    ].map(({ value, icon, label }) => (
                                        <button
                                            key={value}
                                            onClick={() => onSettingsChange({ ...settings, theme: value })}
                                            className={`p-4 rounded-lg font-semibold transition-all ${
                                                settings.theme === value
                                                    ? 'bg-green-500 text-white shadow-lg scale-105'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                        >
                                            <div className="text-3xl mb-1">{icon}</div>
                                            {label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* í† ê¸€ ì˜µì…˜ */}
                            <div className="space-y-4">
                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <div className="font-bold text-gray-800">ğŸ“³ ì§„ë™ í”¼ë“œë°±</div>
                                        <div className="text-sm text-gray-600">íƒ­í•  ë•Œ ì§„ë™ì„ ëŠê»´ìš”</div>
                                    </div>
                                    <button
                                        onClick={() => onSettingsChange({ ...settings, vibration: !settings.vibration })}
                                        className={`w-14 h-8 rounded-full transition-colors ${
                                            settings.vibration ? 'bg-blue-500' : 'bg-gray-300'
                                        }`}
                                    >
                                        <div className={`w-6 h-6 bg-white rounded-full transition-transform ${
                                            settings.vibration ? 'translate-x-7' : 'translate-x-1'
                                        }`} />
                                    </button>
                                </div>

                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <div className="font-bold text-gray-800">ğŸ‘ï¸ ê°€ì´ë“œì„ </div>
                                        <div className="text-sm text-gray-600">ë¹›ì˜ ê³ ë¦¬ë¥¼ í‘œì‹œí•´ìš”</div>
                                    </div>
                                    <button
                                        onClick={() => onSettingsChange({ ...settings, guideLine: !settings.guideLine })}
                                        className={`w-14 h-8 rounded-full transition-colors ${
                                            settings.guideLine ? 'bg-blue-500' : 'bg-gray-300'
                                        }`}
                                    >
                                        <div className={`w-6 h-6 bg-white rounded-full transition-transform ${
                                            settings.guideLine ? 'translate-x-7' : 'translate-x-1'
                                        }`} />
                                    </button>
                                </div>
                            </div>

                            {/* ì‹œì‘ ë²„íŠ¼ */}
                            <button
                                onClick={() => onNavigate('game')}
                                className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white text-xl font-bold rounded-xl hover:from-blue-600 hover:to-purple-600 transition-all shadow-lg hover:shadow-xl"
                            >
                                ê²Œì„ ì‹œì‘í•˜ê¸° ğŸš€
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ê²Œì„ í™”ë©´
        function GameScreen({ settings, onNavigate, onScoreSubmit, currentTeam }) {
            const [gameState, setGameState] = useState('ready'); // ready, playing, paused, finished
            const [score, setScore] = useState(0);
            const [combo, setCombo] = useState(0);
            const [maxCombo, setMaxCombo] = useState(0);
            const [judgements, setJudgements] = useState({ perfect: 0, great: 0, good: 0, miss: 0 });
            const [currentBeat, setCurrentBeat] = useState(0);
            const [showJudgement, setShowJudgement] = useState(null);
            const [rings, setRings] = useState([]);
            const [showPauseMenu, setShowPauseMenu] = useState(false);
            const lastBeatTimeRef = useRef(null);
            const gameStartTimeRef = useRef(null);
            const pauseTimeRef = useRef(null);

            const beatInterval = 60000 / settings.bpm; // BPMì„ msë¡œ ë³€í™˜
            const totalBeats = 30; // ì´ ë¹„íŠ¸ ìˆ˜

            // íŒì • ê¸°ì¤€ (ms) - ì ë‹¹íˆ ì‰½ê²Œ
            const judgementTiming = {
                easy: { perfect: 300, great: 500, good: 700 },
                normal: { perfect: 250, great: 400, good: 550 },
                hard: { perfect: 200, great: 350, good: 500 }
            };

            const timing = judgementTiming[settings.difficulty];

            // ê²Œì„ ì‹œì‘
            const startGame = () => {
                setGameState('playing');
                setScore(0);
                setCombo(0);
                setMaxCombo(0);
                setJudgements({ perfect: 0, great: 0, good: 0, miss: 0 });
                setCurrentBeat(0);
                setRings([]);
                setShowPauseMenu(false);
                const now = Date.now();
                gameStartTimeRef.current = now;
                lastBeatTimeRef.current = now;

                // ì²« ë¹„íŠ¸ ì†Œë¦¬
                soundSystem.playSound(settings.soundPack, 'beat');
                if (settings.guideLine) {
                    setRings([{ id: now, startTime: now }]);
                }
            };

            // ì¼ì‹œì •ì§€
            const pauseGame = () => {
                setGameState('paused');
                setShowPauseMenu(true);
                pauseTimeRef.current = Date.now();
            };

            // ê³„ì†í•˜ê¸°
            const resumeGame = () => {
                const pauseDuration = Date.now() - pauseTimeRef.current;
                lastBeatTimeRef.current += pauseDuration;
                setGameState('playing');
                setShowPauseMenu(false);
            };

            // ê²Œì„ ì¢…ë£Œ
            const quitGame = () => {
                setGameState('ready');
                setShowPauseMenu(false);
                onNavigate('home');
            };

            // ê²Œì„ ë¡œì§
            useEffect(() => {
                if (gameState !== 'playing') return;

                const interval = setInterval(() => {
                    setCurrentBeat(prev => {
                        const next = prev + 1;
                        if (next >= totalBeats) {
                            setGameState('finished');
                            return prev;
                        }

                        // í˜„ì¬ ë¹„íŠ¸ ì‹œê°„ ê¸°ë¡
                        const now = Date.now();
                        lastBeatTimeRef.current = now;

                        // ë¹„íŠ¸ ì†Œë¦¬ ì¬ìƒ
                        soundSystem.playSound(settings.soundPack, 'beat');

                        // ê°€ì´ë“œ ë§ ì¶”ê°€
                        if (settings.guideLine) {
                            setRings(prev => [...prev, { id: now, startTime: now }]);
                        }

                        return next;
                    });
                }, beatInterval);

                return () => clearInterval(interval);
            }, [gameState, beatInterval, settings.soundPack, settings.guideLine]);

            // maxCombo ì—…ë°ì´íŠ¸
            useEffect(() => {
                setMaxCombo(prev => Math.max(prev, combo));
            }, [combo]);

            // ë§ ì• ë‹ˆë©”ì´ì…˜
            useEffect(() => {
                if (gameState !== 'playing') return;
                const interval = setInterval(() => {
                    setRings(prev => prev.filter(ring => Date.now() - ring.startTime < beatInterval));
                }, 50);
                return () => clearInterval(interval);
            }, [gameState, beatInterval]);

            // íƒ­ ì²˜ë¦¬
            const handleTap = () => {
                if (gameState !== 'playing' || !lastBeatTimeRef.current) return;

                const now = Date.now();
                const diff = Math.abs(now - lastBeatTimeRef.current);

                let judgement, points;
                if (diff <= timing.perfect) {
                    judgement = 'Perfect';
                    points = 100;
                } else if (diff <= timing.great) {
                    judgement = 'Great';
                    points = 70;
                } else if (diff <= timing.good) {
                    judgement = 'Good';
                    points = 50;
                } else {
                    judgement = 'Miss';
                    points = 0;
                }

                // ì¦‰ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (judgement !== 'Miss') {
                    setCombo(prev => prev + 1);
                    // ì½¤ë³´ ë³´ë„ˆìŠ¤ëŠ” 5ì ì”©ë§Œ
                    setScore(prev => prev + points + Math.min(combo * 2, 50));
                    setJudgements(prev => ({ ...prev, [judgement.toLowerCase()]: prev[judgement.toLowerCase()] + 1 }));
                    soundSystem.playSound(settings.soundPack, judgement.toLowerCase());
                } else {
                    setCombo(0);
                    setJudgements(prev => ({ ...prev, miss: prev.miss + 1 }));
                    soundSystem.playSound(settings.soundPack, 'miss');
                }

                setShowJudgement(judgement);

                // ì§„ë™
                if (settings.vibration && navigator.vibrate) {
                    navigator.vibrate(judgement === 'Perfect' ? 50 : 20);
                }

                setTimeout(() => setShowJudgement(null), 500);
            };

            const themeClass = {
                sky: 'bg-gradient-sky',
                space: 'bg-gradient-space',
                ocean: 'bg-gradient-ocean',
                forest: 'bg-gradient-forest'
            }[settings.theme];

            if (gameState === 'finished') {
                return (
                    <div className={`min-h-screen ${themeClass} flex items-center justify-center p-6`}>
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h2 className="text-3xl font-bold text-center mb-6">ğŸ‰ ê²Œì„ ì™„ë£Œ!</h2>
                            
                            <div className="space-y-4 mb-6">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600">ìµœì¢… ì ìˆ˜</div>
                                    <div className="text-3xl font-bold text-blue-600">{score.toLocaleString()}</div>
                                </div>
                                
                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600">ìµœëŒ€ ì½¤ë³´</div>
                                    <div className="text-2xl font-bold text-purple-600">{maxCombo}</div>
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg space-y-2">
                                    <div className="flex justify-between">
                                        <span className="text-pink-600 font-semibold">Perfect:</span>
                                        <span>{judgements.perfect}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-blue-600 font-semibold">Great:</span>
                                        <span>{judgements.great}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-green-600 font-semibold">Good:</span>
                                        <span>{judgements.good}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600 font-semibold">Miss:</span>
                                        <span>{judgements.miss}</span>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-3">
                                <button
                                    onClick={startGame}
                                    className="w-full py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-all"
                                >
                                    ë‹¤ì‹œ í•˜ê¸°
                                </button>
                                <button
                                    onClick={() => onNavigate('settings')}
                                    className="w-full py-3 bg-purple-500 text-white font-bold rounded-lg hover:bg-purple-600 transition-all"
                                >
                                    ì„¤ì • ë³€ê²½
                                </button>
                                <button
                                    onClick={() => {
                                        onScoreSubmit({ score, maxCombo, judgements });
                                        onNavigate('home');
                                    }}
                                    className="w-full py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition-all"
                                >
                                    í™ˆìœ¼ë¡œ
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen ${themeClass} flex flex-col`}>
                    {/* ì¼ì‹œì •ì§€ ë©”ë‰´ */}
                    {showPauseMenu && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
                                <h2 className="text-3xl font-bold text-center mb-6">â¸ï¸ ì¼ì‹œì •ì§€</h2>

                                <div className="space-y-4 mb-6">
                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <div className="flex justify-between mb-2">
                                            <span className="text-gray-600">í˜„ì¬ ì ìˆ˜</span>
                                            <span className="font-bold text-blue-600">{score}</span>
                                        </div>
                                        <div className="flex justify-between mb-2">
                                            <span className="text-gray-600">ì½¤ë³´</span>
                                            <span className="font-bold text-purple-600">{combo}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">ì§„í–‰</span>
                                            <span className="font-bold">{currentBeat}/{totalBeats}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <button
                                        onClick={resumeGame}
                                        className="w-full py-4 bg-green-500 text-white text-xl font-bold rounded-lg hover:bg-green-600 transition-all"
                                    >
                                        â–¶ï¸ ê³„ì†í•˜ê¸°
                                    </button>
                                    <button
                                        onClick={startGame}
                                        className="w-full py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-all"
                                    >
                                        ğŸ”„ ë‹¤ì‹œ ì‹œì‘
                                    </button>
                                    <button
                                        onClick={quitGame}
                                        className="w-full py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition-all"
                                    >
                                        ğŸ  í™ˆìœ¼ë¡œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ìƒë‹¨ ì •ë³´ */}
                    <div className="bg-white/90 backdrop-blur-sm p-4 shadow-lg">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <button
                                onClick={gameState === 'playing' ? pauseGame : () => onNavigate('home')}
                                className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all"
                            >
                                {gameState === 'playing' ? 'â¸ï¸ ì¼ì‹œì •ì§€' : 'â† ë’¤ë¡œê°€ê¸°'}
                            </button>

                            <div className="flex items-center space-x-6">
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">íŒ€</div>
                                    <div className="text-xl font-bold text-green-600">{currentTeam + 1}íŒ€</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">BPM</div>
                                    <div className="text-xl font-bold">{settings.bpm}</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ì ìˆ˜</div>
                                    <div className="text-xl font-bold text-blue-600">{score}</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ì½¤ë³´</div>
                                    <div className="text-xl font-bold text-purple-600">{combo}</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ì§„í–‰</div>
                                    <div className="text-xl font-bold">{currentBeat}/{totalBeats}</div>
                                </div>
                            </div>

                            <div className="w-20"></div>
                        </div>
                    </div>

                    {/* ê²Œì„ ì˜ì—­ */}
                    <div className="flex-1 flex items-center justify-center relative">
                        {gameState === 'ready' && (
                            <div className="text-center">
                                <h2 className="text-4xl font-bold text-white mb-8">ì¤€ë¹„ë˜ì…¨ë‚˜ìš”?</h2>
                                <button
                                    onClick={startGame}
                                    className="px-12 py-6 bg-white text-2xl font-bold rounded-2xl shadow-2xl hover:scale-105 transition-transform"
                                >
                                    ì‹œì‘í•˜ê¸°!
                                </button>
                            </div>
                        )}

                        {gameState === 'playing' && (
                            <div className="relative">
                                {/* ê°€ì´ë“œ ë§ë“¤ */}
                                {settings.guideLine && rings.map(ring => {
                                    const elapsed = Date.now() - ring.startTime;
                                    const progress = elapsed / beatInterval;
                                    const scale = 3 - (progress * 2);
                                    const opacity = 1 - progress;
                                    
                                    return (
                                        <div
                                            key={ring.id}
                                            className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 rounded-full border-4 border-white/50"
                                            style={{
                                                width: `${scale * 80}px`,
                                                height: `${scale * 80}px`,
                                                opacity: opacity
                                            }}
                                        />
                                    );
                                })}

                                {/* ì¤‘ì•™ íƒ€ê²Ÿ */}
                                <div className="relative">
                                    <div className="w-40 h-40 rounded-full bg-white/20 backdrop-blur-sm border-4 border-white shadow-2xl" />
                                    
                                    {/* íŒì • í…ìŠ¤íŠ¸ */}
                                    {showJudgement && (
                                        <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl font-bold ${
                                            showJudgement === 'Perfect' ? 'text-pink-400' :
                                            showJudgement === 'Great' ? 'text-blue-400' :
                                            showJudgement === 'Good' ? 'text-green-400' :
                                            'text-gray-400'
                                        } animate-bounce`}>
                                            {showJudgement}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* íƒ­ ë²„íŠ¼ */}
                    {gameState === 'playing' && (
                        <div className="p-8 pb-12">
                            <button
                                onClick={handleTap}
                                className="w-full py-8 bg-white/90 backdrop-blur-sm text-2xl font-bold rounded-2xl shadow-2xl active:scale-95 transition-transform"
                            >
                                ë¹›ì˜ ê³ ë¦¬ê°€ ì¤‘ì•™ì— ë‹¿ì„ ë•Œ íƒ­! ğŸ‘ˆ
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // ë¯¸ë‹ˆê²Œì„ í™”ë©´ (ì†Œë¦¬ ë§íˆê¸°)
        function MiniGameScreen({ onNavigate }) {
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [score, setScore] = useState(0);
            const [answered, setAnswered] = useState(false);
            const [selectedAnswer, setSelectedAnswer] = useState(null);

            // ì†Œë¦¬ ì¬ìƒ í•¨ìˆ˜ë“¤
            const playQuestionSound = (soundType) => {
                soundSystem.init();
                console.log('Playing sound:', soundType); // ë””ë²„ê¹…ìš©

                if (soundType === "ë¹—ì†Œë¦¬") {
                    // ë¹—ì†Œë¦¬: ì—¬ëŸ¬ ê°œì˜ ì§§ì€ ë…¸ì´ì¦ˆë¥¼ ëœë¤í•˜ê²Œ
                    for (let i = 0; i < 25; i++) {
                        setTimeout(() => {
                            const freq = 1200 + Math.random() * 1000;
                            soundSystem.playTone(freq, 0.1, 'sine', 0.4);
                        }, i * 50 + Math.random() * 25);
                    }
                } else if (soundType === "ê°•ì•„ì§€ ì§–ëŠ” ì†Œë¦¬") {
                    // ê°•ì•„ì§€: ë‚®ì€ ìŒì—ì„œ ë†’ì€ ìŒìœ¼ë¡œ ë¹ ë¥´ê²Œ
                    soundSystem.playTone(200, 0.12, 'sawtooth', 0.6);
                    setTimeout(() => soundSystem.playTone(350, 0.18, 'sawtooth', 0.6), 120);
                    setTimeout(() => {
                        soundSystem.playTone(200, 0.12, 'sawtooth', 0.6);
                        setTimeout(() => soundSystem.playTone(350, 0.18, 'sawtooth', 0.6), 120);
                    }, 500);
                } else if (soundType === "ë“œëŸ¼ ì†Œë¦¬") {
                    // ë“œëŸ¼: ë‚®ì€ ì£¼íŒŒìˆ˜ì˜ í‘ ì†Œë¦¬
                    soundSystem.playTone(50, 0.5, 'triangle', 0.7);
                    setTimeout(() => soundSystem.playTone(50, 0.5, 'triangle', 0.7), 700);
                }
            };

            const questions = [
                {
                    question: "ì´ ì†Œë¦¬ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?",
                    sound: "ë¹—ì†Œë¦¬",
                    description: "ìª¼ë¡œë¡± ìª¼ë¡œë¡±",
                    options: ["ë¹—ì†Œë¦¬", "ê°•ì•„ì§€", "ë“œëŸ¼", "í”¼ì•„ë…¸"],
                    correct: 0,
                    explanation: "ë¹—ë°©ìš¸ì´ ë–¨ì–´ì§€ëŠ” ì†Œë¦¬ëŠ” ë¶ˆê·œì¹™í•œ ë¦¬ë“¬ì„ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤."
                },
                {
                    question: "ì´ ì†Œë¦¬ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?",
                    sound: "ê°•ì•„ì§€ ì§–ëŠ” ì†Œë¦¬",
                    description: "ë©ë©!",
                    options: ["ê³ ì–‘ì´", "ê°•ì•„ì§€", "ìƒˆ", "ì‚¬ì"],
                    correct: 1,
                    explanation: "ê°•ì•„ì§€ì˜ ì„±ëŒ€ê°€ ë¹ ë¥´ê²Œ ì§„ë™í•˜ë©´ì„œ ë§Œë“¤ì–´ì§„ ì†Œë¦¬ì…ë‹ˆë‹¤."
                },
                {
                    question: "ì´ ì†Œë¦¬ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?",
                    sound: "ë“œëŸ¼ ì†Œë¦¬",
                    description: "ë‘¥! ë‘¥!",
                    options: ["ê¸°íƒ€", "í”¼ì•„ë…¸", "ë“œëŸ¼", "íŠ¸ëŸ¼í«"],
                    correct: 2,
                    explanation: "ë“œëŸ¼ì˜ ë§‰ì´ ì§„ë™í•˜ë©´ì„œ ë§Œë“¤ì–´ì§„ ì†Œë¦¬ì…ë‹ˆë‹¤."
                }
            ];

            const handleAnswer = (index) => {
                if (answered) return;
                
                setSelectedAnswer(index);
                setAnswered(true);
                
                if (index === questions[currentQuestion].correct) {
                    setScore(prev => prev + 100);
                }
            };

            const nextQuestion = () => {
                if (currentQuestion < questions.length - 1) {
                    setCurrentQuestion(prev => prev + 1);
                    setAnswered(false);
                    setSelectedAnswer(null);
                }
            };

            const restart = () => {
                setCurrentQuestion(0);
                setScore(0);
                setAnswered(false);
                setSelectedAnswer(null);
            };

            const q = questions[currentQuestion];
            const isFinished = answered && currentQuestion === questions.length - 1;

            return (
                <div className="min-h-screen bg-gradient-to-br from-orange-100 to-pink-100 p-6">
                    <div className="max-w-2xl mx-auto">
                        {/* í—¤ë” */}
                        <div className="flex items-center justify-between mb-6">
                            <button
                                onClick={() => onNavigate('home')}
                                className="px-4 py-2 bg-white rounded-lg shadow hover:shadow-md transition-shadow"
                            >
                                â† í™ˆìœ¼ë¡œ
                            </button>
                            <h2 className="text-2xl font-bold text-gray-800">ì†Œë¦¬ ë§íˆê¸° ê²Œì„</h2>
                            <div className="text-xl font-bold text-orange-600">ì ìˆ˜: {score}</div>
                        </div>

                        {!isFinished ? (
                            <div className="bg-white rounded-2xl shadow-xl p-8">
                                {/* ì§„í–‰ë„ */}
                                <div className="mb-6">
                                    <div className="flex justify-between text-sm text-gray-600 mb-2">
                                        <span>ë¬¸ì œ {currentQuestion + 1}</span>
                                        <span>{currentQuestion + 1} / {questions.length}</span>
                                    </div>
                                    <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div 
                                            className="h-full bg-orange-500 transition-all duration-500"
                                            style={{ width: `${((currentQuestion + 1) / questions.length) * 100}%` }}
                                        />
                                    </div>
                                </div>

                                {/* ì§ˆë¬¸ */}
                                <div className="text-center mb-8">
                                    <h3 className="text-2xl font-bold text-gray-800 mb-4">{q.question}</h3>
                                    <div className="mb-4">
                                        <button
                                            onClick={() => playQuestionSound(q.sound)}
                                            className="text-6xl p-4 hover:scale-110 transition-transform active:scale-95 cursor-pointer bg-orange-100 hover:bg-orange-200 rounded-full border-4 border-orange-300 shadow-lg"
                                            title="í´ë¦­í•˜ì—¬ ì†Œë¦¬ ë“£ê¸°"
                                        >
                                            ğŸ”Š
                                        </button>
                                        <div className="text-sm text-orange-600 font-bold mt-2">â†‘ í´ë¦­í•˜ì—¬ ì†Œë¦¬ ë“£ê¸°</div>
                                    </div>
                                    <div className="text-xl text-gray-600 italic">"{q.description}"</div>
                                </div>

                                {/* ì„ íƒì§€ */}
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    {q.options.map((option, index) => (
                                        <button
                                            key={index}
                                            onClick={() => handleAnswer(index)}
                                            disabled={answered}
                                            className={`p-6 rounded-xl text-lg font-semibold transition-all ${
                                                answered
                                                    ? index === q.correct
                                                        ? 'bg-green-500 text-white scale-105'
                                                        : index === selectedAnswer
                                                        ? 'bg-red-500 text-white'
                                                        : 'bg-gray-200 text-gray-500'
                                                    : 'bg-blue-100 hover:bg-blue-200 text-gray-800'
                                            }`}
                                        >
                                            {option}
                                        </button>
                                    ))}
                                </div>

                                {/* ì„¤ëª… */}
                                {answered && (
                                    <div className="bg-blue-50 p-4 rounded-lg mb-6">
                                        <div className="font-bold text-blue-800 mb-2">
                                            {selectedAnswer === q.correct ? 'âœ… ì •ë‹µì…ë‹ˆë‹¤!' : 'âŒ ì•„ì‰½ë„¤ìš”!'}
                                        </div>
                                        <p className="text-gray-700">{q.explanation}</p>
                                    </div>
                                )}

                                {/* ë‹¤ìŒ ë²„íŠ¼ */}
                                {answered && currentQuestion < questions.length - 1 && (
                                    <button
                                        onClick={nextQuestion}
                                        className="w-full py-4 bg-orange-500 text-white text-xl font-bold rounded-xl hover:bg-orange-600 transition-all"
                                    >
                                        ë‹¤ìŒ ë¬¸ì œ â†’
                                    </button>
                                )}
                            </div>
                        ) : (
                            <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
                                <h3 className="text-3xl font-bold text-gray-800 mb-6">ğŸ‰ ì™„ë£Œ!</h3>
                                <div className="text-6xl mb-4">
                                    {score === questions.length * 100 ? 'ğŸ†' : score >= questions.length * 66 ? 'â­' : 'ğŸ‘'}
                                </div>
                                <div className="text-4xl font-bold text-orange-600 mb-2">{score}ì </div>
                                <div className="text-gray-600 mb-8">
                                    {score === questions.length * 100 
                                        ? 'ì™„ë²½í•´ìš”! ì†Œë¦¬ ë°•ì‚¬ë‹˜!' 
                                        : score >= questions.length * 66 
                                        ? 'ì˜í–ˆì–´ìš”!' 
                                        : 'ì¢‹ì•„ìš”! ë‹¤ì‹œ ë„ì „í•´ë´ìš”!'}
                                </div>
                                <div className="space-y-3">
                                    <button
                                        onClick={restart}
                                        className="w-full py-3 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600 transition-all"
                                    >
                                        ë‹¤ì‹œ í•˜ê¸°
                                    </button>
                                    <button
                                        onClick={() => onNavigate('home')}
                                        className="w-full py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition-all"
                                    >
                                        í™ˆìœ¼ë¡œ
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ê°€ì¡± ëŒ€í•­ì „ í™”ë©´
        function TeamBattleScreen({ sessionId, onNavigate, currentTeam, setCurrentTeam }) {
            const [teams, setTeams] = useState([
                { name: '1íŒ€', score: 0, combo: 0 },
                { name: '2íŒ€', score: 0, combo: 0 },
                { name: '3íŒ€', score: 0, combo: 0 }
            ]);
            const [loading, setLoading] = useState(true);

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° ì‹¤ì‹œê°„ êµ¬ë…
            useEffect(() => {
                // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                const loadTeams = async () => {
                    const data = await DB.getTeams(sessionId);
                    if (data.length > 0) {
                        const teamsData = [
                            { name: '1íŒ€', score: 0, combo: 0 },
                            { name: '2íŒ€', score: 0, combo: 0 },
                            { name: '3íŒ€', score: 0, combo: 0 }
                        ];
                        data.forEach(item => {
                            teamsData[item.team_index] = {
                                name: item.team_name,
                                score: item.score,
                                combo: item.combo
                            };
                        });
                        setTeams(teamsData);
                    }
                    setLoading(false);
                };

                loadTeams();

                // ì‹¤ì‹œê°„ êµ¬ë…
                const channel = DB.subscribeToTeams(sessionId, (payload) => {
                    loadTeams(); // ë³€ê²½ì‚¬í•­ ë°œìƒ ì‹œ ë‹¤ì‹œ ë¡œë“œ
                });

                return () => {
                    if (channel) {
                        supabase.removeChannel(channel);
                    }
                };
            }, [sessionId]);

            const handleResetTeams = async () => {
                if (confirm('ì •ë§ë¡œ ëª¨ë“  íŒ€ì˜ ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    await DB.resetTeams(sessionId);
                    setTeams([
                        { name: '1íŒ€', score: 0, combo: 0 },
                        { name: '2íŒ€', score: 0, combo: 0 },
                        { name: '3íŒ€', score: 0, combo: 0 }
                    ]);
                }
            };

            const sortedTeams = [...teams].sort((a, b) => b.score - a.score);
            const winner = sortedTeams[0];

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-red-100 to-orange-100 flex items-center justify-center">
                        <div className="text-2xl font-bold text-gray-800">ë¡œë”© ì¤‘...</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-red-100 to-orange-100 p-6">
                    <div className="max-w-4xl mx-auto">
                        {/* í—¤ë” */}
                        <div className="flex items-center justify-between mb-6">
                            <button
                                onClick={() => onNavigate('home')}
                                className="px-4 py-2 bg-white rounded-lg shadow hover:shadow-md transition-shadow"
                            >
                                â† í™ˆìœ¼ë¡œ
                            </button>
                            <h2 className="text-2xl font-bold text-gray-800">ğŸ† ê°€ì¡± ëŒ€í•­ì „</h2>
                            <div className="w-20"></div>
                        </div>

                        {/* ì ìˆ˜íŒ */}
                        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
                            <h3 className="text-2xl font-bold text-center mb-6">ì ìˆ˜íŒ</h3>
                            <div className="space-y-4">
                                {sortedTeams.map((team, index) => (
                                    <div
                                        key={team.name}
                                        className={`p-6 rounded-xl flex items-center justify-between ${
                                            index === 0 
                                                ? 'bg-yellow-100 border-4 border-yellow-400' 
                                                : 'bg-gray-50'
                                        }`}
                                    >
                                        <div className="flex items-center space-x-4">
                                            <span className="text-3xl">
                                                {index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : ''}
                                            </span>
                                            <div>
                                                <div className="text-xl font-bold">{team.name}</div>
                                                <div className="text-sm text-gray-600">ìµœëŒ€ ì½¤ë³´: {team.combo}</div>
                                            </div>
                                        </div>
                                        <div className="text-3xl font-bold text-blue-600">
                                            {team.score.toLocaleString()}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {winner.score > 0 && (
                                <div className="mt-8 text-center">
                                    <div className="text-4xl mb-2">ğŸ‰</div>
                                    <div className="text-2xl font-bold text-gray-800">
                                        ì¶•í•˜í•©ë‹ˆë‹¤! {winner.name} ìš°ìŠ¹!
                                    </div>
                                    <div className="text-gray-600 mt-2">
                                        ë¦¬ë“¬ ë§ˆìŠ¤í„° ì¹­í˜¸ë¥¼ ë“œë¦½ë‹ˆë‹¤! â­
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* ê·œì¹™ ì•ˆë‚´ */}
                        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
                            <h3 className="text-xl font-bold mb-4">ğŸ“‹ ëŒ€ê²° ê·œì¹™</h3>
                            <ul className="space-y-2 text-gray-700">
                                <li className="flex items-start">
                                    <span className="mr-2">â€¢</span>
                                    <span>ê³µì •í•˜ê²Œ: ëª¨ë“  íŒ€ì€ ê°™ì€ ë‚œì´ë„ë¡œ ì‹œì‘í•´ìš”</span>
                                </li>
                                <li className="flex items-start">
                                    <span className="mr-2">â€¢</span>
                                    <span>ì•ˆì „í•˜ê²Œ: ì°¨ë¡€ë¥¼ ì§€ì¼œì£¼ì„¸ìš”</span>
                                </li>
                                <li className="flex items-start">
                                    <span className="mr-2">â€¢</span>
                                    <span>ì‘ì›í•˜ë©°: í•¨ê»˜ ì‘ì›í•´ìš”!</span>
                                </li>
                            </ul>
                        </div>

                        {/* í˜„ì¬ ì°¨ë¡€ í‘œì‹œ */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="text-center">
                                <p className="text-gray-600 mb-2">ë‹¤ìŒ ì°¨ë¡€</p>
                                <p className="text-4xl font-bold text-blue-600">{currentTeam + 1}íŒ€</p>
                            </div>
                        </div>

                        {/* ê²Œì„ ì‹œì‘ */}
                        <div className="space-y-3">
                            <button
                                onClick={() => onNavigate('game')}
                                className="w-full py-4 bg-gradient-to-r from-red-500 to-orange-500 text-white text-xl font-bold rounded-xl hover:from-red-600 hover:to-orange-600 transition-all shadow-lg"
                            >
                                ê²Œì„ ì‹œì‘í•˜ê¸° ğŸ®
                            </button>
                            <button
                                onClick={handleResetTeams}
                                className="w-full py-3 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600 transition-all"
                            >
                                ì ìˆ˜íŒ ì´ˆê¸°í™”
                            </button>
                        </div>

                        <p className="text-center text-gray-600 mt-6">
                            ê°€ì¡±ì´ í•¨ê»˜í•˜ëŠ” ë¦¬ë“¬ ëŒ€ê²°! ëª¨ë‘ê°€ ì±”í”¼ì–¸ì…ë‹ˆë‹¤. ğŸ’–
                        </p>
                    </div>
                </div>
            );
        }

        // ì•± ë Œë”ë§
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
